---
- name: Configure control plane loadbalancers
  hosts: cp_lbs
  tags: loadbalancer
  remote_user: ubuntu
  become: true
  roles:
    - role: control-plane-lb

- name: Configure master nodes
  hosts: masters
  tags: master
  remote_user: ubuntu
  become: true
  roles:
    - role: common
    - role: master

- name: Configure worker nodes
  hosts: workers
  tags: worker
  remote_user: ubuntu
  become: true
  pre_tasks:
    - name: Get join command from masters
      command: kubeadm token create --print-join-command
      register: kubectl_worker_join_command
      changed_when: false
      delegate_to: "{{ groups.masters[0] }}"
      # when: kubectl_worker_join_command not defined
  roles:
  - role: common
  - role: worker
